<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Keweenaw Geoheritage & Two-Eyed Seeing GeoAtlas</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css" />
         
    <script src="https://kit.fontawesome.com/36f08f062d.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.0/viewer.css" integrity="sha512-tYobxYoCZxl0CejYCA8c4w8HRcg3wRoKaGYIQ/2ILqyB4vRqMd/Jmehxod1dQJ2uE/9rDY9pG48isM8SHEAwDQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />    
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.0/viewer.js" integrity="sha512-psAniLUS9J4A5KNQiSt9XMNeVSMx/Rz89vQJqeYlOIiTR5WK8zU/8EPwAKt+522eeV04QUzIwX5VrAW10FbdeQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  
    <script src="https://js.arcgis.com/4.27/"></script>
    <style>    
     
    /*Map container*/
    #viewDiv {
      position: absolute;
      top: 0;
      bottom: 0;        
      padding: 0;
      margin-top: 56px;        
      width: 100%;
    }

     .esri-ui .esri-popup  {
      display:  none !important;
    }      

    h2 {
      display: inline-block;
      font-size: 18px;
      padding: 5px;
    }

    h4 {
      display: inline-block;
      padding-left: 5px;
      color: white;
    }

    .modal-footer {
      background-color: #1F5983;
    }
    
    /*Navbar height*/
    .navbar {
      height: 56.5px;  
    }

    /*Main Navbar Title and Logo*/
    .navbar-brand {
      padding: 0 10px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px; 
      font-weight: bold;  
      letter-spacing: 1px; 
      text-shadow: 2px 4px 3px rgba(0,0,0,0.3);
    }

    /*Navbar links*/
    .navbar-light .navbar-nav .nav-link {
      color: #d9dde0;
      font-size: 13px;
    }

    .navbar-light .navbar-nav .nav-link:visited {
      color: #d9dde0;  
    }

    .navbar-light .navbar-nav .nav-link:hover {
      color: white;  
    }

    /*Navbar link color*/
    .navbar-light .navbar-brand {
      color: white;
    }

    /*Navbar link color*/
    .navbar-light .navbar-brand:visited {
      color: white;
    }

    /*Navbar background color*/
    .bg-light {
      background: #1F5983 !important;
      border-bottom: solid 2px black;
    }       

    .navbar-brand {
      position: absolute;       
      left: 0;        
    }

    .navbar-light .navbar-brand:hover {
      color: white; 
    }

    .img-thumbnail {
      width: 150px;
    }

   /* Style buttons */
  .btn {
    background-color: #1F5983; /* Blue background */
    border: 2px solid #1F5983; /* Remove borders */
    color: white; /* White text */
    padding: 12px 16px; /* Some padding */
    font-size: 16px; /* Set a font size */
    cursor: pointer; /* Mouse pointer on hover */
    margin-bottom: 10px;
    margin-left: 8px;
  }

  /* Darker background on mouse-over */
  .btn:hover {
    background-color: #3996b8;
    color: #f3f3f3;
  }

  #output {
    color:  orange;
    font-size:  18px;
    font-weight:  bolder;
    padding: 5px;
  }

  /* ESRI widget buttons color */
  .esri-widget--button {
    color: white;
    background-color: #EF973B;
  }

   .modal-dialog {
      position: absolute !important;
      top: 0px;
      right: 15px;
      z-index: 9999999999999999999999999 !important;
    }

    .modal-backdrop {
      display: none !important;
      zindex-modal: -1;
    }

    .modal-header {
      background-color: #EF973B !important ;
      color: white;
    }

    #storyModal .modal-header {
      background-color: #809955 !important ;
      color: white;
    }

    #storyModal .modal-footer {
      background-color: #809955 !important ;
      color: white;
    }

    .btn-close {
      opacity: 100 !important;
    }


     
    </style>
    
    <script>
      require(["esri/Map", "esri/views/MapView", "esri/config", "esri/WebMap", "esri/layers/TileLayer", "esri/widgets/LayerList", "esri/widgets/Expand", "esri/widgets/Swipe", "esri/widgets/Legend", "esri/widgets/Print", "esri/widgets/BasemapGallery", "esri/Basemap", "esri/core/reactiveUtils", "esri/portal/Portal"], (Map, MapView, esriConfig, WebMap, TileLayer, LayerList, Expand, Swipe, Legend, Print, BasemapGallery, Basemap, reactiveUtils, Portal) => {

          $("#sound").hide(); // sound button hidden by default
          $("#listen").hide(); // listen test hidden by default

        var popupModal = new bootstrap.Modal(document.getElementById('modal'))

        var storyModal = new bootstrap.Modal(document.getElementById('storyModal'))

        $("#listenBtn").hide();

        // Set the portal URL
        esriConfig.portalUrl = "https://portal1-geo.sabu.mtu.edu/mtuarcgis/";
        const webmap = new WebMap({
          portalItem: { // autocasts as new PortalItem()
            id: "69222fc39cc84ebaae92a446bd73da0b"
          }
        });
        const view = new MapView({
          container: "viewDiv", // Reference to the view div created in step 5
          map: webmap, // Reference to the map object created before the view          
          popup:{
            highlightEnabled: true,
            dockEnabled: false,
            dockOptions: {
                buttonEnabled: false,
                breakpoint: false,
                position:"top-center"
            }
          }
        });

        // renderer for the geoheritage reflections layer
        const renderer = {
         type: "simple",
         symbol: {
            type: "picture-marker",
            url: 'images/camera.png',
            width: 20,
            height: 20
         }
        }

        // renderer for the mining sites layer
        const siteRenderer = {
         type: "simple",
         symbol: {
            type: "picture-marker",
            url: 'images/mining.png',
            width: 15,
            height: 15
         }
        }

        // renderer for the mining sites layer
        const storyRenderer = {
         type: "simple",
         symbol: {
            type: "picture-marker",
            url: 'images/story.png',
            width: 20,
            height: 20
         }
        }

        view.when(function() { 
          let reflections = webmap.allLayers.find(function(layer) {          
            return layer.title === "Geoheritage Internship Reflections";
          });

          let storyPoints = webmap.allLayers.find(function(layer) {          
            return layer.title === "Geoheritage Internship StoryMap Points";
          });

          let sites = webmap.allLayers.find(function(layer) {          
            return layer.title === "Keweenaw Historic Mining Locations and Settlements";
          });

          reflections.renderer = renderer;
          storyPoints.renderer = storyRenderer;
          sites.renderer = siteRenderer;

          // what the popup for a selected feature 
          reactiveUtils.watch(
            () => view.popup.selectedFeature,
            (graphic) => {
              if (graphic) {
                  console.log(graphic);
                  if (graphic.layer.title === "Geoheritage Internship Reflections") {  
                    document.getElementById("sound").innerHTML = ""; 
                    $("#sound").hide(); // sound button hidden by default
                    $("#listen").hide(); // listen button hidden by default
                  // create variables from the graphic's attributes
                  var q1 = graphic.attributes.does_this_place_have_another_na;
                  var q2 = graphic.attributes.what_rocks_are_present_here;
                  var q3 = graphic.attributes.what_rocks_are_present_here_oth;
                  var q4 = graphic.attributes.what_is_the_geological_significan;
                  var q5 = graphic.attributes.what_is_the_cultural_significan;
                  var q6 = graphic.attributes.what_5_words_would_you_use_to_d;
                  var q7 = graphic.attributes.what_3_words_would_you_use_to_d;
                  var q8 = graphic.attributes.what_stories_are_present_herel
                  var q9 = graphic.attributes.what_environmental_stories_are;
                  var q10 = graphic.attributes.what_stories_are_missing_here;
                  var title = graphic.attributes.what_is_the_name_of_this_place;
                  // use the variables in the html elements
                  // we do this instead of using an standard esri popup
                  $('#storytitle').html(title);
                  $('#q1').html(q1);
                  $('#q2').html(q2);
                  $('#q3').html(q3);
                  $('#q4').html(q4);
                  $('#q5').html(q5);
                  $('#q6').html(q6);
                  $('#q7').html(q7);
                  $('#q8').html(q8);
                  $('#q9').html(q9);
                  $('#q10').html(q10);  
                                
                   popupModal.show();
                   storyModal.hide();
                   // Get a reference to the modal element
                var modal = document.getElementById('modal');

                // Remove the "show" class from the modal
                modal.classList.remove('modal');

                  document.getElementById("pictures").innerHTML = "";                 
                  $("#listenBtn").hide();
                  $(".modal-footer").hide();
                  const featId = graphic.attributes.objectid;
                  console.log("reflection" + featId);
                  reflections.queryAttachments({
          //  attachmentTypes: ["image/jpeg", "video/mp4", "sound/mp3"],
                    objectIds: featId
                  }).then(function (attachmentsByFeatureId) {
            console.log(attachmentsByFeatureId);
            if (!attachmentsByFeatureId) {
                return;
             }
            if (Object.keys(attachmentsByFeatureId).length === 0){
              // if there are no attachments, do something here.
              //$("#storyimg").attr("src", "");                   
             }
            // Display the attachments
            Object.keys(attachmentsByFeatureId)
              .forEach(function(objectId) {
                const attachments = attachmentsByFeatureId[objectId];
                attachments.forEach(function (attachment) {                   
                  if (attachment.contentType == "image/jpeg" || attachment.contentType == "image/png" || attachment.contentType == "image/gif") {
                   
                    const imgarray = [];
                    imgarray.push(attachment);
                    const attachUrl = imgarray[0].url;
                    //$("#main_img").attr("src",attachUrl);
                    imgarray.forEach(function(image, index) {
                       // create a new anchor element 
                       const anchor = document.createElement("a");
                       anchor.href = imgarray[0].url; // Set the href to the full-size image URL
                       anchor.target = "_blank";  
                      
                        const elem = document.createElement("img");
                        elem.src = imgarray[0].url + "?w=600";
                        elem.className = "img-fluid img-thumbnail";   
                        anchor.appendChild(elem);                    
                        document.getElementById("pictures").appendChild(anchor);
                     
                    }); 
                  
                  } else if (attachment.contentType == "audio/mpeg" || attachment.contentType == "audio/wav" || attachment.contentType == "video/mp4") {                    
                    const audarray = [];
                    audarray.push(attachment);
                    console.log(audarray.length);
                    audUrl = audarray[0].url;
                    //const audio = new Audio(audUrl);
                    console.log("audio files" + audarray[0].url);
                    $('.modal-footer').show(); 
                    $("#listenBtn").show();

                    const audio = document.createElement('audio');
                    const source = document.createElement('source');
                    const type = attachment.contentType;

                    source.setAttribute('src', audUrl);
                    source.setAttribute('type', 'audio/mpeg');
                    document.getElementById("sound").appendChild(audio);
                    audio.appendChild(source);  
                    audio.controls = "true";
                    //audio.style.width = "100%";
                    audio.load();
                    $("#sound").show();
                    $("#listen").show();

                    const btn = document.getElementById("listenBtn");

                       btn.addEventListener("click", () => {
                          audio.play();
                          $("#sound").show();
                          $("#listenBtn").hide();

                        });                   
                  }                   
                });
              }); 
                })
              } else if (graphic.layer.title === "Geoheritage Internship StoryMap Points"){
                var author = graphic.attributes.storymap_author;
                var link = graphic.attributes.storymap_link;
                var storyTitle = graphic.attributes.storymap_title;

                $('#maptitle').html(storyTitle);
                $('#rowtitle').html(storyTitle);
                $('#author').html(author);
                var link = document.getElementById('storyurl');
                link.href = graphic.attributes.storymap_link; 
                var smodal = document.getElementById('storyModal');

                // Remove the "show" class from the modal
                smodal.classList.remove('modal');

                storyModal.show();
                popupModal.hide();
                   
              }
              } 
            }
          );

       // setup the basemaps for the custom gallery 
       const customBasemap = new Basemap({
        portalItem: {
          id: "6499e3d99bca49e3aab71b53cfde4e53"
        }
      })  
      
       const topoBasemap = new Basemap({
        portalItem: {
          id: "9defe445862a413a8310829567e5d407"
        }
      })

        const gloBasemap = new Basemap({
        portalItem: {
          id: "3a42a7a6624d46aa9873fa4d8e4aa832"
        }
      })              
   

        let basemapGallery = new BasemapGallery({
          view: view,
           source: new Portal({url: "https://portal1-geo.sabu.mtu.edu/mtuarcgis/"}), // autocasts to PortalBasemapsSource
           source: [Basemap.fromId("hybrid"), gloBasemap, topoBasemap] // autocasts to LocalBasemapsSource
        });
        // Add widget to the top right corner of the view
        view.ui.add(basemapGallery, {
          position: "bottom-left"
        });         

        // print widget
        const print = new Print({
          view: view,
          // specify your own print service
          printServiceUrl:
             "https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
        });

        // print expand
         printExpand = new Expand({
          expandIconClass: "esri-icon-printer",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
          expandTooltip: "Print Map", // optional, defaults to "Expand" for English locale
          view: view,
          content: print
        });

          view.ui.add(printExpand, "top-left");
          // LayerList
          layerList = new LayerList({
            container: document.createElement("div"),
            view: view,
            multipleSelectionEnabled: true,
            selectionEnabled: true
          });

          layerListExpand = new Expand({
            expandIconClass: "esri-icon-layers",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
            expandTooltip: "Expand LayerList", // optional, defaults to "Expand" for English locale
            view: view,
            content: layerList
          });

          view.ui.add(layerListExpand, "top-left");
         
          // setup a new swipe widget
          var swipe;     
          var swipeBtn = document.createElement('div');
          // Find all non-basemap layers
          const nonBasemapLayers = webmap.layers.filter(function (layer) {
            return !layer.basemap;
          });

          // Create an array of the non-basemap layers
          const nonBasemapLayerList = nonBasemapLayers.toArray();

          // Create a leadingLayers array for the Swipe widget
          const leadingLayers = nonBasemapLayerList.map(function (layer) {
            return layer;
          });
          
          swipeBtn.className = "esri-icon-dock-left esri-widget--button esri-widget esri-interactive";
          swipeBtn.title = "Compare maps";
          swipeBtn.addEventListener('click', function(event){
            // create a new Swipe widget
              swipe = new Swipe({
                leadingLayers: leadingLayers,              
                position: 35, // set position of widget to 35%
                view: view
              });
            view.ui.add(swipe);
            $(".esri-icon-close").show(); 
            $(".esri-icon-dock-left").hide();
          });    //  });       
        

          // Add the button to the UI
          view.ui.add(swipeBtn, "top-left");  

          var closeBtn = document.createElement('div');
          closeBtn.className = "esri-icon-close esri-widget--button esri-widget esri-interactive";
          closeBtn.title = "Exit swipe";
          closeBtn.addEventListener('click', function(event){
            swipe.destroy();
            $(".esri-icon-close").hide(); 
            $(".esri-icon-dock-left").show();
          });

          // Add the button to the UI
          view.ui.add(closeBtn, "top-left");  

          $(".esri-icon-close").hide();       
    }); 
  });
    </script>
  </head>
  <body>
     <!-- Main navbar -->
    <nav class="navbar navbar-expand-md navbar-light bg-light">
  <a class="navbar-brand" href="https://mtugrf.github.io/hdcmap/" target="_blank" rel="noopener">
    <img src="images/logo.jpg" width="50" height="50" class="d-inline-block align-top" alt="">
      &nbsp;<div id="title">Keweenaw Geoheritage & Two-Eyed Seeing GeoAtlas</div>
  </a>
  <div class="collapse navbar-collapse" id="navbarNav" style="">
     <!--    <ul class="navbar-nav mr-auto">           
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="https://portal1-geo.sabu.mtu.edu/mtuarcgis/apps/sites/#/geoheritage-and-two-eyed-seeing" target="_blank" rel="noopener">Two-Eyed Seeing</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://www.mtu.edu/greatlakes/shared-facilities/geospatial/" target="_blank" rel="noopener">MTU GRF</a>
            </li>            
        </ul> -->
    </div>
</nav> 
    <div id="viewDiv"></div>  
    <div class="modal" data-bs-backdrop="false" data-bs-keyboard="false" tabindex="-1" id="storyModal">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Geoheritage StoryMap: <div id="maptitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">        
        <table class="table table-striped table-bordered" style="margin-top: 5px">         
          <tbody>
            <tr>
              <th scope="row">StoryMap Title</th>
              <td><div id="rowtitle"></div></td>              
            </tr>
            <tr>
              <th scope="row">StoryMap Author</th>
              <td><div id="author"></div></td>             
            </tr> 
            <tr>
              <th scope="row">StoryMap Link</th>
              <td><a href="url" id="storyurl"  target="_blank">View StoryMap</a></td>             
            </tr>            
            </tr>            
          </tbody>
        </table>
      </div>      
    </div>
  </div>
</div>
</div>

    <div class="modal" data-bs-backdrop="false" data-bs-keyboard="false" tabindex="-1" id="modal">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Geoheritage Reflections: <div id="storytitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="pictures" class=".img-thumbnail"></div>
        <table class="table table-striped table-bordered" style="margin-top: 5px">         
          <tbody>
            <tr>
              <th scope="row">Does this place have another name?</th>
              <td><div id="q1"></div></td>              
            </tr>
            <tr>
              <th scope="row">What rocks are present here?</th>
              <td><div id="q2"></div></td>              
            </tr>
            <tr>
              <th scope="row">Other - What Rocks are present here?</th>
              <td><div id="q3"></div></td>              
            </tr>
            <tr>
              <th scope="row">What is the geological significance of this place?</th>
              <td><div id="q4"></div></td>
            </tr>
              <tr>
              <th scope="row">What is the cultural significance of this place?</th>
              <td><div id="q5"></div></td>              
            </tr>
             <tr>
              <th scope="row">What 3 words would you use to describe this place?</th>
              <td><div id="q6"></div></td>              
            </tr>
            <tr>
              <th scope="row">Share 3 thoughts or words about how this place makes you feel.</th>
              <td><div id="q7"></div></td>              
            </tr> 
            <tr>
              <th scope="row">What or whose stories are present?</th>
              <td><div id="q8"></div></td>              
            </tr> 
            <tr>
              <th scope="row">How has the environment here been influenced throughout time?</th>
              <td><div id="q9"></div></td>              
            </tr> 
             <tr>
              <th scope="row">What or whose stories are missing?</th>
              <td><div id="q10"></div></td>              
            </tr> 
            </tr>            
          </tbody>
        </table>
      </div>
      <div class="modal-footer d-flex justify-content-center" id="modalfooter">  
        <div id="listen"><center><i class="fa-solid fa-volume-high fa-2xl" style="color: white"></i>  <h4>Hear This Place</h4></center></div>
        <div id="sound"></div>              
      </div>
    </div>
  </div>
</div>
</div>
  </body>
</html>